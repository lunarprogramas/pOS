<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Verification System</title>
    <link rel="stylesheet" href="style.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getDatabase, ref, set, push, query, orderByChild, equalTo, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBCNTQ0KPOYQpy1t8xdwyYf8CII_MxShd4",
            authDomain: "website-auth-afe12.firebaseapp.com",
            databaseURL: "https://website-auth-afe12-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "website-auth-afe12",
            storageBucket: "website-auth-afe12.appspot.com",
            messagingSenderId: "75474962216",
            appId: "1:75474962216:web:3fd7878b0aaec84274b21d",
            measurementId: "G-159RQF6CDE",
        };
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
    
        document.addEventListener('DOMContentLoaded', function () {
            async function isNameUsed(name) {
                const nameQuery = query(ref(database, 'verified-verification'), orderByChild('discord'), equalTo(name));
                const snapshot = await get(nameQuery);
                return snapshot.exists();
            }

            async function getPlayerInfoAndUpdateUI() {
                const username = document.getElementById('rob_name').value;

                // Check if the username is provided
                if (!username) {
                    console.error('Please enter a valid Roblox username');
                    return;
                }

                try {
                    const response = await fetch(`http://localhost:3000/getPlayerInfo?username=${username}`, {
                        mode: 'cors' // Add this line
                    });

                    if (!response.ok) {
                        throw new Error(`Server responded with status ${response.status}`);
                    }

                    const playerInfo = await response.json();

                    // Set up the event listener here after retrieving playerInfo
                    document.getElementById("submitButton").addEventListener("click", function() {
                        submitData(playerInfo);
                    });

                    // Set the text content of the HTML element with the retrieved player info
                    document.getElementById("submitButton").addEventListener("click", function() {
                submitData(playerInfo);
                })
                } catch (error) {
                    console.error('Error fetching player info:', error.message);
                }
            }

            async function submitData(playerInfo) {
                const nameValue = document.getElementById('name').value;
                const rob = document.getElementById('rob_name').value;
                const decodedPlrInfo = JSON.stringify(playerInfo, null, 2);

                if (nameValue.trim() !== '' && rob.trim() !== '') {
                    // Check if the Discord name is already used
                    if (!(await isNameUsed(nameValue))) {
                        if (decodedPlrInfo === "test") {
                            const newEntryRef = push(ref(database, 'verified-verification'));
                            set(newEntryRef, {
                                discord: nameValue,
                                roblox: rob
                            });

                            await getPlayerInfoAndUpdateUI();

                            // Show success message
                            document.getElementById('successMessage').innerText = 'Data submitted successfully!';
                            setTimeout(function () {
                                document.getElementById('successMessage').innerText = 'Redirecting you to step 2!';
                            }, 5000);
                            setTimeout(function () {
                                window.location.href = "http://127.0.0.1:3001/test.html"
                            }, 5000);
                        } else {
                            console.log(`${decodedPlrInfo}`)
                            document.getElementById('support_txt').innerText = "Your info isn't updated!";
                        }
                    } else {
                        // Show error message if the Discord name is already in use
                        document.getElementById('successMessage').innerText = 'Discord name is already in use. Please choose a different name.';
                    }
                } else {
                    // Show error message if either Discord or ROBLOX name is empty
                    document.getElementById('successMessage').innerText = 'Please enter both your Discord and ROBLOX names!';
                }
            }

            // Trigger getPlayerInfoAndUpdateUI when the page loads

            document.getElementById("submitButton").addEventListener("click", function() {
                getPlayerInfoAndUpdateUI();
});
    
        });
    </script>
</head>

<body>
    

    <header>
        <h2 class="logo">Automated Verification System</h2>
        <nav class="navigation">
            <!-- Add navigation links if needed -->
        </nav>
    </header>

    <div class="verification-box">
        <h2 class="text-box1">pOS</h2>
        <input class="input-box" type="text" placeholder="Discord Name" id="name">
        <input class="rob" type="text" placeholder="ROBLOX Name" id="rob_name">
        <button class="discord-name-submit" id="submitButton">Send</button>
        <p class="success" id="successMessage">Please enter your ROBLOX and Discord name!</p>
        <h2 class="support_txt" id="support_txt">If you're locked out of your account please contact an Administrator to help you!</h2>
    </div>

    <!-- The rest of your body content here -->

    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</body>

</html>
